

<!DOCTYPE html>
<html>
<head>
    <title>ONURBIS - Shapes the Globe</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="L.switchBasemap.css" />

    <style>



    </style>

    <!-- Add this in your HTML <head> section -->
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="L.switchBasemap.js"></script> 
</head>
<body>


    <div id="map"></div>
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Katman Yükleniyor...</div>
    </div>





 

    <script>


document.addEventListener('DOMContentLoaded', function() {

    
        // Initialize the map
        var map = L.map('map').setView([39.5, 35], 6);

        // Define base layers
        var baseLayer1 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri'
        });

        var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Esri'
        });

        // Add the first base layer to the map
        Esri_WorldTopoMap.addTo(map);

        // Create the basemap switcher control
        var basemapSwitcher = L.basemapsSwitcher([

        {
                name: 'Esri World Topo Map',
                icon: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/0/0/0.png', // Use a suitable icon URL
                layer: Esri_WorldTopoMap
            },
            {
                name: 'Esri World Imagery',
                icon: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/0/0/0.png', // Use a suitable icon URL
                layer: Esri_WorldImagery
            },
            {
                name: 'OpenStreetMap',
                icon: 'https://a.tile.openstreetmap.org/0/0/0.png', // Use a suitable icon URL
                layer: baseLayer1
            }

        ], {
            position: 'bottomleft' // Position control at bottom left
        });

        // Add the basemap switcher control to the map
        map.addControl(basemapSwitcher);



        var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
});







    var strmLayer = L.tileLayer.wms('https://tucbs-public-api.csb.gov.tr/trk_srtm_wms', {
        layers: '0',
        format: 'image/png',
        transparent: true,
        attribution: 'SRTM WMS'
    });

    var karayolu = L.tileLayer.wms('https://tucbs-public-api.csb.gov.tr/trk_uab_kgm_karayolu_wms', {
        layers: 'karayolu',
        format: 'image/png',
        transparent: true,
        attribution: 'Karayolu'
    });

    var göller = L.tileLayer.wms('https://tucbs-public-api.csb.gov.tr/trk_sygm_yerustu_su_kutlesi_gol_wms', {
        layers: 'yerustu_su_kutlesi_gol',
        format: 'image/png',
        transparent: true,
        attribution: 'Su kütlesi (göl) WMS'
    });

    var desertificationLayer = L.tileLayer.wms('https://tucbs-public-api.csb.gov.tr/trk_cemgm_collesmehassasiyetharitasi_wms', {
        layers: '0',
        format: 'image/png',
        transparent: true,
        attribution: 'Collesme Hassasiyeti WMS'
    });

    var biyoatik = L.tileLayer.wms('https://tucbs-public-api.csb.gov.tr/trk_eigm_bepa_2017_bitkisel_atik_miktari_wms', {
        layers: '1348_BEPA_2017_BITKISEL_ATIK_MIKTARI_TON_YIL',
        format: 'image/png',
        transparent: true,
        attribution: 'Biyokütle Enerjisi Potansiyel Atlası - 2017 Bitkisel Atık Miktarı (Ton/Yıl)'
    });

    var lpgstation = L.tileLayer.wms('https://tucbs-public-api.csb.gov.tr/trk_epdk_AkaryakitIstasyonlari_wms', {
        layers: 'AkaryakitIstasyonlari',
        format: 'image/png',
        transparent: true,
        attribution: 'Akaryakıt İstasyonları'
    });



    var overlayMaps = {
        "T.C. Çevre Şehircilik ve İklim Değişikliği Bakanlığı": {
            "Sayısal Yükseklik Modeli - STRM": strmLayer,
            "Karayolu": karayolu,
            "Çölleşme Hassasiyet Haritası": desertificationLayer
        },
        "T.C. Enerji ve Tabii Kaynaklar Bakanlığı ": {
            "Bitkisel Atık Miktarı": biyoatik,
            "Akaryakıt İstasyonları": lpgstation
        },
        "T.C. Tarım ve Orman Bakanlığı": {
            "Sulak Alanlar": göller
        }
    };

    var activeLayers = new Set();
    var loadingLayers = new Set();

    function getLegendUrl(layer) {
        var baseUrl = layer._url;
        var legendUrl = `${baseUrl}?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=${layer.wmsParams.layers}&format=image/png`;
        return legendUrl;
    }

    function createLegendControl(layer) {
        var legendDiv = L.DomUtil.create('div', 'legend-control');
        var img = document.createElement('img');
        img.src = getLegendUrl(layer);
        img.alt = 'Legend';
        img.style.width = 'auto'; // Adjust as needed
        img.style.height = 'auto'; // Maintain aspect ratio
        legendDiv.appendChild(img);
        return legendDiv;
    }

    function createOpacityControl(layer) {
        var controlDiv = L.DomUtil.create('div', 'opacity-control');
        var label = document.createElement('label');
        label.textContent = 'Saydamlık:';
        var slider = document.createElement('input');
        slider.type = 'range';
        slider.min = '0';
        slider.max = '1';
        slider.step = '0.01';
        slider.value = layer.options.opacity || '1';
        slider.className = 'opacity-slider';

        slider.addEventListener('input', function() {
            layer.setOpacity(parseFloat(this.value));
        });

        slider.addEventListener('mousedown', function() {
            map.dragging.disable();
        });
        slider.addEventListener('mouseup', function() {
            map.dragging.enable();
        });

        controlDiv.appendChild(label);
        controlDiv.appendChild(slider);

        return controlDiv;
    }

    function showLoadingSpinner() {
        var container = document.querySelector('.loading-container');
        if (container) {
            container.style.display = 'block';
        }
    }

    function hideLoadingSpinner() {
        var container = document.querySelector('.loading-container');
        if (container) {
            container.style.display = 'none';
        }
    }

    function handleLayerLoading(layer, isLoading) {
        if (isLoading) {
            loadingLayers.add(layer);
            showLoadingSpinner();
        } else {
            loadingLayers.delete(layer);
            if (loadingLayers.size === 0) {
                hideLoadingSpinner();
            }
        }
    }

    function addLayerWithLoadingIndicator(layer) {
        layer.on('loading', function() {
            handleLayerLoading(layer, true);
        });
        layer.on('load', function() {
            handleLayerLoading(layer, false);
        });
        layer.on('error', function() {
            handleLayerLoading(layer, false);
        });
    }

    function updateLayerControl(layer, add) {
        if (add) {
            activeLayers.add(layer);
        } else {
            activeLayers.delete(layer);
            handleLayerLoading(layer, false);  // Ensure spinner is hidden if layer is removed
        }
    }

    for (var groupName in overlayMaps) {
        var group = overlayMaps[groupName];
        for (var layerName in group) {
            var layer = group[layerName];
            addLayerWithLoadingIndicator(layer);
        }
    }

    var customControl = L.control({ position: 'topright' });

    customControl.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'leaflet-control-custom');
        div.innerHTML = '<h3>Katmanlar</h3>';

        for (var groupName in overlayMaps) {
            var group = overlayMaps[groupName];
            var groupContainer = document.createElement('div');
            groupContainer.className = 'layer-group';

            var header = document.createElement('div');
            header.className = 'layer-group-header';
            header.innerHTML = `<span>${groupName}</span><span class="toggle-button">+</span>`;
            groupContainer.appendChild(header);

            var content = document.createElement('div');
            content.className = 'layer-group-content';

            for (var layerName in group) {
                var layer = group[layerName];
                var label = document.createElement('label');
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.layerName = layerName;
                checkbox.dataset.groupName = groupName;

                checkbox.addEventListener('change', function(e) {
                    var targetLayerName = this.dataset.layerName;
                    var targetGroupName = this.dataset.groupName;
                    var targetLayer = overlayMaps[targetGroupName][targetLayerName];
                    var legendControl = createLegendControl(targetLayer);

                    if (e.target.checked) {
                        map.addLayer(targetLayer);
                        updateLayerControl(targetLayer, true);
                        var opacityControl = createOpacityControl(targetLayer);
                        this.parentElement.appendChild(legendControl); // Add the legend image
                        this.parentElement.appendChild(opacityControl);
                    } else {
                        map.removeLayer(targetLayer);
                        updateLayerControl(targetLayer, false);
                        var opacityControl = this.parentElement.querySelector('.opacity-control');
                        var legendControl = this.parentElement.querySelector('.legend-control');
                        if (opacityControl) {
                            this.parentElement.removeChild(opacityControl);
                        }
                        if (legendControl) {
                            this.parentElement.removeChild(legendControl);
                        }
                    }
                });
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(layerName));
                content.appendChild(label);
            }

            groupContainer.appendChild(content);
            div.appendChild(groupContainer);

            header.onclick = function() {
                var button = this.querySelector('.toggle-button');
                var contentDiv = this.nextSibling;
                var isExpanded = contentDiv.style.display === 'block';
                contentDiv.style.display = isExpanded ? 'none' : 'block';
                button.innerHTML = isExpanded ? '+' : '-';
            };
        }

        L.DomEvent.disableClickPropagation(div);
        return div;
    };

    customControl.addTo(map);

   function getFeatureInfo(evt) {
                var point = map.latLngToContainerPoint(evt.latlng, map.getZoom());
                var size = map.getSize();
        
                var requests = Array.from(activeLayers).map(layer => {
                    var params = {
                        request: 'GetFeatureInfo',
                        service: 'WMS',
                        srs: 'EPSG:4326',
                        styles: layer.wmsParams.styles || '',
                        transparent: layer.wmsParams.transparent || true,
                        version: '1.1.1',
                        format: layer.wmsParams.format || 'image/png',
                        bbox: map.getBounds().toBBoxString
